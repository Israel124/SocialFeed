{% extends 'feed/base.html' %}

{% block title %}{{ post.author.username }} en SocialFeed: "{{ post.caption|truncatechars:30 }}"{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card post-card mb-4">
            <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <a href="{% url 'feed:profile' username=post.author.username %}" class="text-decoration-none text-dark">
                        <img src="{{ post.author.profile.profile_picture.url }}" alt="Profile" class="rounded-circle profile-image-small me-3">
                    </a>
                    <div>
                        <a href="{% url 'feed:profile' username=post.author.username %}" class="text-decoration-none text-dark">
                            <h6 class="mb-0 fw-bold">{{ post.author.username }}</h6>
                        </a>
                        <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                    </div>
                </div>

                <!-- Dropdown para opciones de la publicación (Editar/Eliminar) -->
                {% if post.author == user %}
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0" type="button" id="postOptions{{ post.pk }}" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots fs-5"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postOptions{{ post.pk }}">
                        <li><a class="dropdown-item" href="#">
                            <i class="bi bi-pencil me-2"></i>Editar
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'feed:delete_post' pk=post.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item text-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar esta publicación?');">
                                    <i class="bi bi-trash me-2"></i>Eliminar
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <img src="{{ post.image.url }}" alt="{{ post.caption }}" class="img-fluid post-image">
            </div>
            <div class="card-footer bg-white">
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <a href="{% url 'feed:like_post' pk=post.pk %}" class="text-decoration-none text-dark">
                            <i class="action-icon me-3 {% if user in post.likes.all %}bi bi-heart-fill text-danger{% else %}bi bi-heart{% endif %}"></i>
                        </a>
                        <i class="bi bi-chat action-icon me-3"></i>
                        <i class="bi bi-send action-icon"></i>
                    </div>
                    <i class="bi bi-bookmark action-icon"></i>
                </div>
                <p class="mb-1"><strong>{{ post.likes.count }} me gusta</strong></p>
                <p><strong>{{ post.author.username }}</strong> {{ post.caption }}</p>
                
                <hr>

                <!-- Sección de Comentarios -->
                <h6 class="mb-3">Comentarios ({{ comments.count }})</h6>
                {% for comment in comments %}
                <div class="d-flex mb-3">
                    <img src="{{ comment.user.profile.profile_picture.url }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                    <div>
                        <strong>{{ comment.user.username }}</strong>
                        <p class="mb-0 small">{{ comment.text }}</p>
                        <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No hay comentarios todavía.</p>
                {% endfor %}

                <!-- Formulario para Comentar -->
                <div class="comment-form pt-3">
                    <form method="post">
                        {% csrf_token %}
                        <div class="input-group">
                            {{ comment_form.text }}
                            <button class="btn btn-outline-primary" type="submit">Publicar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}